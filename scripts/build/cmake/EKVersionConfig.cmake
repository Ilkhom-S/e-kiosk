# EKVersionConfig.cmake
# Handles version configuration and file generation for EKiosk
# Usage:
#   include(scripts/build/cmake/EKVersionConfig.cmake)
#   ek_configure_version(VERSION "3.0.0" BUILD "123")

function(ek_get_version OUT_VERSION OUT_BUILD)
    if(DEFINED ENV{EK_VERSION})
        set(_version "$ENV{EK_VERSION}")
    elseif(DEFINED EK_VERSION)
        set(_version "${EK_VERSION}")
    else()
        set(_version "3.0.0")
    endif()

    if(DEFINED ENV{BUILD_NUMBER})
        set(_build "$ENV{BUILD_NUMBER}")
    elseif(DEFINED BUILD_NUMBER)
        set(_build "${BUILD_NUMBER}")
    else()
        set(_build "0")
    endif()

    set(${OUT_VERSION} "${_version}" PARENT_SCOPE)
    set(${OUT_BUILD} "${_build}" PARENT_SCOPE)
endfunction()

function(ek_configure_version)
    cmake_parse_arguments(ARG "" "VERSION;USE_TOKEN" "" ${ARGN})

    if(NOT ARG_VERSION)
        ek_get_version(ARG_VERSION _unused)
    endif()
    # Always use timestamp for build value
    string(TIMESTAMP ARG_BUILD "%Y%m%d%H%M" UTC)
    set(ARG_OUTPUT_DIR "${CMAKE_SOURCE_DIR}/include/Common")
    if(NOT ARG_USE_TOKEN)
        set(ARG_USE_TOKEN 0)
    endif()

    string(REPLACE "." ";" VERSION_LIST ${ARG_VERSION})
    list(GET VERSION_LIST 0 VERSION_MAJOR)
    list(GET VERSION_LIST 1 VERSION_MINOR)
    list(GET VERSION_LIST 2 VERSION_PATCH)
    string(REPLACE "." "," VERSION_COMMA "${ARG_VERSION},${ARG_BUILD}")
    file(MAKE_DIRECTORY ${ARG_OUTPUT_DIR})

    if(DEFINED EK_INCLUDES_DIR)
        set(VERSION_H_TEMPLATE "${EK_INCLUDES_DIR}/Common/Version.h.in")
    else()
        set(VERSION_H_TEMPLATE "${CMAKE_SOURCE_DIR}/include/Common/Version.h.in")
    endif()
    if(EXISTS ${VERSION_H_TEMPLATE})
        file(READ ${VERSION_H_TEMPLATE} _version_h_content)
        if(ARG_USE_TOKEN)
            set(_build_repl "${ARG_BUILD} token")
        else()
            set(_build_repl "${ARG_BUILD}")
        endif()
        string(REPLACE "3.0.0" "${ARG_VERSION}" _version_h_content "${_version_h_content}")
        string(REPLACE "000000000000" "${_build_repl}" _version_h_content "${_version_h_content}")
        string(REPLACE "0.0.0.0" "${ARG_VERSION}.${ARG_BUILD}" _version_h_content "${_version_h_content}")
        string(REPLACE "0,0,0,0" "${VERSION_COMMA}" _version_h_content "${_version_h_content}")
        file(WRITE ${ARG_OUTPUT_DIR}/Version.h "${_version_h_content}")
        message(STATUS "Generated ${ARG_OUTPUT_DIR}/Version.h (from template)")
    else()
        message(FATAL_ERROR "Version.h.in template not found: ${VERSION_H_TEMPLATE}")
    endif()

    set(VERSION_RC_TEMPLATE "${CMAKE_SOURCE_DIR}/include/Common/Version.rc.in")
    if(EXISTS ${VERSION_RC_TEMPLATE})
        file(READ ${VERSION_RC_TEMPLATE} _version_rc_content)
        string(REPLACE "0,0,0,0" "${VERSION_MAJOR},${VERSION_MINOR},${VERSION_PATCH},${ARG_BUILD}" _version_rc_content "${_version_rc_content}")
        string(REPLACE "0.0.0.0" "${ARG_VERSION}.${ARG_BUILD}" _version_rc_content "${_version_rc_content}")
        file(WRITE ${ARG_OUTPUT_DIR}/Version.rc "${_version_rc_content}")
        message(STATUS "Generated ${ARG_OUTPUT_DIR}/Version.rc (from template)")
    else()
        message(FATAL_ERROR "Version.rc.in template not found: ${VERSION_RC_TEMPLATE}")
    endif()

    set(EK_VERSION "${ARG_VERSION}" PARENT_SCOPE)
    set(EK_VERSION_MAJOR "${VERSION_MAJOR}" PARENT_SCOPE)
    set(EK_VERSION_MINOR "${VERSION_MINOR}" PARENT_SCOPE)
    set(EK_VERSION_PATCH "${VERSION_PATCH}" PARENT_SCOPE)
    set(EK_BUILD_NUMBER "${ARG_BUILD}" PARENT_SCOPE)
    set(EK_VERSION_GENERATED_DIR "${ARG_OUTPUT_DIR}" PARENT_SCOPE)
endfunction()

function(ek_print_version)
    ek_get_version(_version _build)
    message(STATUS "===========================================")
    message(STATUS "EKiosk Version: ${_version}")
    message(STATUS "Build Number: ${_build}")
    message(STATUS "===========================================")
endfunction()
